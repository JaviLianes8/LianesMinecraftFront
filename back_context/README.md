# Minecraft Server Backend

FastAPI service that orchestrates a modded Minecraft server running on Windows. The API exposes
endpoints to start and stop the server, distribute packaged client files, and obtain on-demand
backups of the full server directory.

## Features

- **Safe lifecycle management**: prevents duplicate starts and enforces a controlled shutdown.
- **Mods distribution**: serves a curated ZIP file containing all required mods for players.
- **NeoForge installer**: exposes the configured installer JAR for quick client provisioning.
- **One-click backups**: generates timestamped ZIP files of the whole server directory.
- **Daily backup workflow**: ensures the latest backup exists before each start and rotates old archives.
- **CORS aware**: origin whitelist driven by environment variables.
- **Clean Architecture**: decoupled domain contracts, use cases, infrastructure adapters,
  and HTTP interface.

## Project structure

```
src/minecraft_server_backend/
├── application/         # Use cases orchestrating domain services
├── config/              # Settings resolution and environment helpers
├── domain/              # Entities, value objects, and domain-specific services
├── infrastructure/      # OS integrations for processes, archives, and storage
├── interfaces/          # HTTP transport layer implemented with FastAPI
└── di.py                # Dependency wiring used by the transport layer
```

## Requirements

- Python 3.11+
- Access to the Windows host that stores `C:\\MinecraftServerModded` and its `run.bat` script.

## Setup

1. Create a virtual environment and install dependencies:

   ```bash
   python -m venv .venv
   source .venv/bin/activate  # On Windows use .venv\\Scripts\\activate
   pip install -e .
   ```

2. Duplicate `.env.example` into `.env` and adjust the paths/origins to match your deployment.

3. Launch the API:

   ```bash
   uvicorn minecraft_server_backend.main:app --host 0.0.0.0 --port 8000
   ```

## Development

Run the automated checks locally with:

```bash
pytest
```

## Environment variables

| Variable | Description |
|----------|-------------|
| `APP_HOST` | Host where FastAPI will bind. Used when spawning via `uvicorn` programmatically. |
| `APP_PORT` | Port for the HTTP service. |
| `CORS_ALLOWED_ORIGINS` | Comma-separated origins allowed to perform cross-site requests. |
| `MINECRAFT_START_SCRIPT` | Absolute path to `run.bat`. |
| `MINECRAFT_SERVER_ROOT` | Root directory of the Minecraft server. |
| `MINECRAFT_MODS_ARCHIVE` | Absolute path to the ZIP file with all required mods. |
| `MINECRAFT_NEOFORGE_INSTALLER` | Absolute path to the NeoForge installer JAR. |
| `MINECRAFT_BACKUP_ROOT` | Optional directory to persist generated backups. Defaults to a `backups/` sibling of the server root. |
| `BACKUP_RETENTION_DAYS` | Minimum number of days to keep previous backups when ensuring the daily archive (defaults to 7). |

## API

The API is mounted under `/api`.

| Method | Route | Description |
|--------|-------|-------------|
| `POST` | `/api/server/start` | Starts the server. Returns HTTP 409 if already running. |
| `POST` | `/api/server/stop` | Stops the server. Returns HTTP 409 if no process is running. |
| `GET`  | `/api/server/status` | Returns whether the server process is running. |
| `GET`  | `/api/mods/download` | Downloads the curated mods ZIP archive. |
| `GET`  | `/api/neoforge/download` | Downloads the NeoForge installer JAR. |
| `GET`  | `/api/server/backup` | Streams a ZIP backup for the entire server folder. |

### Example usage

```bash
# Start server
curl -X POST http://localhost:8000/api/server/start

# Stop server
curl -X POST http://localhost:8000/api/server/stop

# Server status
curl http://localhost:8000/api/server/status

# Download mods
curl -OJ http://localhost:8000/api/mods/download

# Download NeoForge installer
curl -OJ http://localhost:8000/api/neoforge/download

# Download backup
curl -OJ http://localhost:8000/api/server/backup
```

## Documentation

Autogenerated API documentation is available with Sphinx:

```bash
pip install .[docs]
cd docs
make html
```

Open `docs/_build/html/index.html` in your browser to inspect the rendered documentation.

## Security recommendations

- Protect the API with a reverse proxy and authentication when exposing it publicly.
- Rotate the RCON password and restrict firewall access to trusted control panels.
- Store downloaded backups in a hardened location after transfer.

## License

MIT
